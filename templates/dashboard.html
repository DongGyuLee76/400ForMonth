{% extends 'base.html' %}

{% block content %}
<div class="dashboard-grid">
    <div class="card">
        <h3>Total Plan Duration</h3>
        <div class="value">{{ plans|length if plans else 0 }} Years</div>
    </div>
    <div class="card">
        <h3>Current Total Assets (2026)</h3>
        <div class="value">
            {% if plans %}
            {{ "{:,.0f}".format(plans[0]['total']) }}
            {% else %}
            0
            {% endif %}
        </div>
    </div>
    <div class="card">
        <h3>Final Projected Assets (2066)</h3>
        <div class="value">
            {% if plans %}
            {{ "{:,.0f}".format(plans[-1]['total']) }}
            {% else %}
            0
            {% endif %}
        </div>
    </div>

</div>

<!-- New Section: Current Year & Projection -->
<div class="dashboard-grid" style="grid-template-columns: 1fr 2fr; margin-top: 20px;">
    <!-- Current Year Summary -->
    <div class="card">
        <h3>2026 Performance (Current)</h3>
        {% if current_stat %}
        <div style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #94a3b8;">Target:</span>
                <span style="font-weight: bold;">{{ "{:,.0f}".format(current_stat.goal_total) }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <span style="color: #94a3b8;">Actual:</span>
                <span style="font-weight: bold; color: var(--accent-color);">{{ "{:,.0f}".format(current_stat.total)
                    }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <span style="color: #94a3b8;">Gap:</span>
                <span style="font-weight: bold; color: {{ '#f87171' if current_stat.gap_total < 0 else '#4ade80' }};">
                    {{ "{:+,.0f}".format(current_stat.gap_total) }}
                </span>
            </div>
            <div style="text-align: center; padding: 15px; border-radius: 8px; background: rgba(255,255,255,0.03);">
                <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 5px;">Achievement Rate</div>
                <div
                    style="font-size: 1.8rem; font-weight: bold; color: {{ '#4ade80' if current_stat.gap_pct >= 100 else '#f87171' }};">
                    {{ current_stat.gap_pct }}%
                </div>
            </div>
        </div>
        {% else %}
        <p style="color: #94a3b8;">No data for 2026.</p>
        {% endif %}
    </div>

    <!-- Year Projection Selector -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Future Projection (+3 Years)</h3>
            <form action="{{ url_for('index') }}" method="GET" id="projForm">
                <select name="proj_year" onchange="document.getElementById('projForm').submit()"
                    style="padding: 5px 10px; border-radius: 4px; background: #1e293b; color: #e2e8f0; border: 1px solid #334155;">
                    {% for s in summary %}
                    <option value="{{ s.year }}" {{ 'selected' if s.year==selected_year else '' }}>{{ s.year }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
        <div class="table-container" style="background: transparent; padding: 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <th style="padding: 10px; text-align: left; color: #94a3b8;">Year</th>
                        <th style="padding: 10px; text-align: right; color: #94a3b8;">Pension</th>
                        <th style="padding: 10px; text-align: right; color: #94a3b8;">ISA</th>
                        <th style="padding: 10px; text-align: right; color: #94a3b8;">General</th>
                        <th style="padding: 10px; text-align: right; color: #94a3b8;">Total</th>
                        <th style="padding: 10px; text-align: right; color: #94a3b8;">Target</th>
                        <th style="padding: 10px; text-align: right; color: #94a3b8;">Achv %</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in projection %}
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 10px; font-weight: bold;">{{ p.year }}</td>
                        <td style="padding: 10px; text-align: right;">{{ "{:,.0f}".format(p.pension) }}</td>
                        <td style="padding: 10px; text-align: right;">{{ "{:,.0f}".format(p.isa) }}</td>
                        <td style="padding: 10px; text-align: right;">{{ "{:,.0f}".format(p.general) }}</td>
                        <td style="padding: 10px; text-align: right; font-weight: bold; color: var(--accent-color);">{{
                            "{:,.0f}".format(p.total) }}</td>
                        <td style="padding: 10px; text-align: right; color: #94a3b8;">{{ "{:,.0f}".format(p.goal_total)
                            }}</td>
                        <td
                            style="padding: 10px; text-align: right; font-weight: bold; color: {{ '#4ade80' if p.gap_pct >= 100 else '#f87171' }};">
                            {{ p.gap_pct }} %
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="dashboard-grid" style="margin-top: 20px;">
    <div class="card chart-container">
        <h3>Individual Accounts</h3>
        <canvas id="accountChart"></canvas>
    </div>

    <div class="card chart-container">
        <h3>Total Assets Projection</h3>
        <canvas id="totalChart"></canvas>
    </div>
</div>

<div class="table-container">
    <h3>Financial Plan Overview</h3>
    <table>
        <thead>
            <tr>
                <th>Year (Age)</th>
                <th>Pension</th>
                <th>ISA</th>
                <th>General</th>
                <th>Total</th>
                <th>Health Ins.</th>
                <th>Tax</th>
                <th>Strategy</th>
            </tr>
        </thead>
        <tbody>
            {% for plan in plans %}
            <tr>
                <td>{{ plan['year'] }} ({{ plan['age'] }})</td>
                <td>{{ "{:,.0f}".format(plan['pension_savings']) }}</td>
                <td>{{ "{:,.0f}".format(plan['isa_account']) }}</td>
                <td>{{ "{:,.0f}".format(plan['general_account']) }}</td>
                <td style="font-weight: bold; color: var(--accent-color);">{{ "{:,.0f}".format(plan['total']) }}</td>
                <td>{{ plan['health_insurance'] }}</td>
                <td>{{ plan['tax'] }}</td>
                <td>{{ plan['withdrawal_strategy'] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        Chart.register(ChartDataLabels); // Register the plugin

        const ctxAccount = document.getElementById('accountChart').getContext('2d');
        const ctxTotal = document.getElementById('totalChart').getContext('2d');

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#94a3b8' }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    titleColor: '#e2e8f0',
                    bodyColor: '#e2e8f0',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: '#94a3b8' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        };

        fetch('/api/chart-data')
            .then(response => response.json())
            .then(data => {
                // Chart 1: Individual Accounts
                const maxGeneral = Math.max(...data.general);

                new Chart(ctxAccount, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Pension',
                                data: data.pension,
                                borderColor: '#4ade80', /* green-400 */
                                backgroundColor: 'rgba(74, 222, 128, 0.1)',
                                tension: 0.4,
                                fill: true,
                                order: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'ISA',
                                data: data.isa,
                                borderColor: '#fbbf24', /* amber-400 */
                                backgroundColor: 'rgba(251, 191, 36, 0.1)',
                                tension: 0.4,
                                fill: true,
                                order: 2,
                                yAxisID: 'y'
                            },
                            {
                                type: 'bar',
                                label: 'General',
                                data: data.general,
                                backgroundColor: 'rgba(244, 114, 182, 0.3)', /* pink-400 transparent */
                                borderColor: 'rgba(244, 114, 182, 0.8)',
                                borderWidth: 1,
                                order: 3,
                                yAxisID: 'y1',
                                barPercentage: 0.5
                            }
                        ]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                position: 'left',
                                title: { display: true, text: 'Pension / ISA', color: '#94a3b8' }
                            },
                            y1: {
                                display: true,
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                ticks: { color: '#f472b6' },
                                min: 0,
                                max: maxGeneral * 3, // Push bars to bottom 1/3
                                title: { display: true, text: 'General Account', color: '#f472b6' }
                            }
                        }
                    }
                });

                // Chart 2: Total Assets
                new Chart(ctxTotal, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Total Assets',
                                data: data.total,
                                borderColor: '#38bdf8', /* sky-400 */
                                backgroundColor: 'rgba(56, 189, 248, 0.6)',
                                borderWidth: 1,
                                borderRadius: 4,
                                hoverBackgroundColor: '#38bdf8',
                                tension: 0.4,
                                fill: true,
                                barPercentage: 0.7
                            }
                        ]
                    },
                    options: {
                        ...commonOptions,
                        plugins: {
                            ...commonOptions.plugins,
                            datalabels: {
                                color: '#ffffff',
                                anchor: 'end',
                                align: 'top',
                                offset: -4,
                                font: {
                                    weight: 'bold',
                                    size: 11
                                },
                                formatter: function (value) {
                                    // Convert Man-won (10,000) to Million-won (1,000,000)
                                    // Value / 100
                                    return Math.round(value / 100).toLocaleString();
                                },
                                rotation: -90,
                                display: 'auto',
                            },
                            tooltip: {
                                ...commonOptions.plugins.tooltip,
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            // Show both original and million unit in tooltip
                                            const manWon = context.parsed.y;
                                            const millionWon = Math.round(manWon / 100).toLocaleString();
                                            label += millionWon + ' 백만원 (' + manWon.toLocaleString() + ' 만원)';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                title: {
                                    display: true,
                                    text: 'Total Assets (단위: 백만원)',
                                    color: '#38bdf8',
                                    font: { size: 12, weight: 'bold' }
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    callback: function (value) {
                                        return (value / 100).toLocaleString();
                                    }
                                }
                            },
                            x: {
                                ...commonOptions.scales.x,
                                ticks: {
                                    autoSkip: true,
                                    maxRotation: 45,
                                    minRotation: 45, // Slant labels for better reading
                                    color: '#cbd5e1'
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            });
    });
</script>
{% endblock %}